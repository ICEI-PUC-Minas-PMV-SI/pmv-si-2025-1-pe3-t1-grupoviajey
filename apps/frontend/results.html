<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados da Busca | Viajey</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/results.css">
  <link rel="stylesheet" href="components/header/header.css">
  <link rel="stylesheet" href="components/footer/footer.css">
  <link rel="stylesheet" href="components/search-bar/search-bar.css">
  <link rel="stylesheet" href="components/cards/result-card.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="components/cards/result-card.js"></script>
</head>
<body>
  <div id="header"></div>
  <main>
    <section class="results-header-section">
      <div class="results-header-container">
        <h1 class="results-title">Explorando Balneário Camboriú</h1>
        <div id="search-bar-include"></div>
      </div>
    </section>
    <section class="results-filters-section">
      <div class="filters-container">
        <div class="filters-left">
          <button class="filter-btn active">Hotel</button>
          <button class="filter-btn">Restaurantes</button>
          <button class="filter-btn">Atrações</button>
        </div>
        <div class="filters-right">
          <button class="filter-btn"><img src="/apps/frontend/images/funnel.svg" style="width:18px;height:18px;vertical-align:middle;margin-right:4px;">Filtros</button>
          <button class="filter-btn"><img src="/apps/frontend/images/sort.svg" style="width:18px;height:18px;vertical-align:middle;margin-right:4px;">Organizar</button>
        </div>
      </div>
    </section>
    <section class="results-content-section">
      <div class="results-grid-map-container">
        <div class="results-grid"></div>
        <div class="results-map">
          <button id="search-area-btn">Buscar nesta área</button>
          <div id="map" style="width:100%;height:100%;background:#e0e0e0;"></div>
        </div>
      </div>
    </section>
  </main>
  <div id="footer"></div>
  <div id="place-details-modal-include"></div>
  <div id="reviews-modal-include"></div>
  <script src="js/include.js"></script>
  <script>
    const API_KEY = 'AIzaSyBYvz7j7Rj0AfCx15nW6a9Rcw-AYKoqw2k';
    const RADIUS = 2000;
    let map, service, markers = [], lastCenter = null, lastZoom = 14;
    let btn, moved = false;
    let selectedType = 'lodging';

    function renderResults(results) {
      const grid = document.querySelector('.results-grid');
      grid.innerHTML = '';
      const filtered = results.filter(place => isTypeMatch(place, selectedType));
      filtered.forEach((place, index) => {
        const card = window.createResultCard({
          image: '',
          title: place.name,
          rating: place.rating || 0,
          tags: place.types ? place.types.slice(0, 2) : [],
          address: place.vicinity || '',
          price_level: undefined
        });
        card.classList.add('result-card');
        card.dataset.placeIndex = index;

        // Renomear o botão de 'result-btn' para 'add-roteiro-btn'
        const addRoteiroBtn = card.querySelector('.result-btn');
        if (addRoteiroBtn) {
          addRoteiroBtn.classList.remove('result-btn');
          addRoteiroBtn.classList.add('add-roteiro-btn');
        }

        // Adiciona eventos de hover
        card.addEventListener('mouseenter', () => {
          if (markers[index]) {
            markers[index].setAnimation(google.maps.Animation.BOUNCE);
            markers[index].setZIndex(1000);
          }
        });
        card.addEventListener('mouseleave', () => {
          if (markers[index]) {
            markers[index].setAnimation(null);
            markers[index].setZIndex(1);
          }
        });

        // Modal só abre ao clicar no card, exceto no botão de roteiro
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('add-roteiro-btn')) {
            if (typeof openPlaceDetailsModal === 'function') {
              // Salvar dados do local no localStorage
              const buscaAtual = getBuscaPersistida();
              const dadosAtualizados = {
                ...buscaAtual,
                rating: place.rating || 0,
                address: place.vicinity || '',
                placeName: place.name
              };
              localStorage.setItem('buscaViajey', JSON.stringify(dadosAtualizados));

              openPlaceDetailsModal({
                name: place.name,
                address: place.vicinity || '',
                rating: place.rating || 0
              });
            }
          }
        });

        // Dropdown de roteiro no botão do card
        const btn = card.querySelector('.add-roteiro-btn');
        const dropdown = card.querySelector('.roteiro-dropdown');
        const lista = card.querySelector('.roteiro-lista');
        const criar = card.querySelector('.roteiro-criar');
        const input = card.querySelector('.roteiro-input');
        const salvar = card.querySelector('.roteiro-salvar');
        const feedback = card.querySelector('.roteiro-feedback');

        if (btn && dropdown && lista && criar && input && salvar && feedback) {
          btn.onclick = function(e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            criar.style.display = 'none';
            feedback.style.display = 'none';
          };
          document.addEventListener('click', function docClick(ev) {
            if (!dropdown.contains(ev.target) && ev.target !== btn) {
              dropdown.style.display = 'none';
            }
          });
          lista.querySelectorAll('.roteiro-item').forEach(item => {
            if (item.textContent === '+ Criar novo roteiro') {
              item.onclick = function(e) {
                e.stopPropagation();
                criar.style.display = 'flex';
                input.value = '';
                input.focus();
              };
            } else {
              item.onclick = function(e) {
                e.stopPropagation();
                dropdown.style.display = 'none';
                mostrarFeedback(`Adicionado ao roteiro <b>${item.textContent}</b> <span style='color:green;font-size:1.2em;'>✔️</span>`);
              };
            }
          });
          salvar.onclick = function(e) {
            e.stopPropagation();
            const nome = input.value.trim();
            if (nome) {
              dropdown.style.display = 'none';
              criar.style.display = 'none';
              mostrarFeedback(`Adicionado ao roteiro <b>${nome}</b> <span style='color:green;font-size:1.2em;'>✔️</span>`);
            }
          };
          function mostrarFeedback(msg) {
            feedback.innerHTML = msg;
            feedback.style.display = 'flex';
            setTimeout(() => { feedback.style.display = 'none'; }, 2200);
          }
        }

        grid.appendChild(card);
      });

      // Cria o dropdown flutuante uma vez
      let floatingDropdown = document.getElementById('floating-roteiro-dropdown');
      if (!floatingDropdown) {
        floatingDropdown = document.createElement('div');
        floatingDropdown.id = 'floating-roteiro-dropdown';
        floatingDropdown.className = 'floating-roteiro-dropdown';
        floatingDropdown.innerHTML = `
          <div class="roteiro-lista">
            <div class="roteiro-item">Viagem SC</div>
            <div class="roteiro-item">Férias 2024</div>
            <div class="roteiro-item">+ Criar novo roteiro</div>
          </div>
          <div class="roteiro-criar" style="display:none;">
            <input type="text" placeholder="Nome do roteiro" class="roteiro-input" />
            <button class="roteiro-salvar">Salvar</button>
          </div>
          <div class="roteiro-feedback" style="display:none;"></div>
        `;
        document.body.appendChild(floatingDropdown);
      }

      // Função para mostrar o dropdown flutuante próximo ao botão
      function showFloatingDropdown(btn) {
        const floatingDropdown = document.getElementById('floating-roteiro-dropdown');
        if (!floatingDropdown) return;

        // Fecha outros dropdowns
        floatingDropdown.style.display = 'none';

        // Pega posição do botão
        const rect = btn.getBoundingClientRect();
        floatingDropdown.style.top = `${rect.top}px`;
        floatingDropdown.style.right = `${window.innerWidth - rect.right + 56}px`;
        floatingDropdown.style.display = 'block';

        // Resetar estados do dropdown
        const criar = floatingDropdown.querySelector('.roteiro-criar');
        const feedback = floatingDropdown.querySelector('.roteiro-feedback');
        criar.style.display = 'none';
        feedback.style.display = 'none';

        // Atualizar eventos dos itens
        const lista = floatingDropdown.querySelector('.roteiro-lista');
        const input = floatingDropdown.querySelector('.roteiro-input');
        const salvar = floatingDropdown.querySelector('.roteiro-salvar');

        lista.querySelectorAll('.roteiro-item').forEach(item => {
          item.onclick = function(ev) {
            ev.stopPropagation();
            if (item.textContent === '+ Criar novo roteiro') {
              criar.style.display = 'flex';
              input.value = '';
              input.focus();
            } else {
              mostrarFeedback(`Adicionado ao roteiro <b>${item.textContent}</b> <span style='color:green;font-size:1.2em;'>✔️</span>`);
              setTimeout(() => {
                floatingDropdown.style.display = 'none';
              }, 2200);
            }
          };
        });

        salvar.onclick = function(ev) {
          ev.stopPropagation();
          const nome = input.value.trim();
          if (nome) {
            mostrarFeedback(`Adicionado ao roteiro <b>${nome}</b> <span style='color:green;font-size:1.2em;'>✔️</span>`);
            setTimeout(() => {
              floatingDropdown.style.display = 'none';
              criar.style.display = 'none';
            }, 2200);
          }
        };

        function mostrarFeedback(msg) {
          feedback.innerHTML = msg;
          feedback.style.display = 'flex';
          clearTimeout(feedback._timeout);
          feedback._timeout = setTimeout(() => {
            feedback.style.display = 'none';
          }, 2200);
        }

        // Fechar o dropdown ao clicar fora
        document.addEventListener('click', function closeDropdown(e) {
          if (!floatingDropdown.contains(e.target) && e.target !== btn) {
            floatingDropdown.style.display = 'none';
            document.removeEventListener('click', closeDropdown);
          }
        });
      }

      // Adiciona evento a todos os botões .add-roteiro-btn após renderização dos cards
      function bindFloatingDropdownToCards() {
        document.querySelectorAll('.add-roteiro-btn').forEach(btn => {
          btn.onclick = function(e) {
            e.stopPropagation();
            showFloatingDropdown(btn);
          };
        });
      }

      // Chame bindFloatingDropdownToCards() sempre após renderResults
      // Exemplo: logo após grid.appendChild(card);
      bindFloatingDropdownToCards();

      // Fechar o dropdown flutuante ao clicar fora dele ou do botão
      document.addEventListener('click', function(ev) {
        const floatingDropdown = document.getElementById('floating-roteiro-dropdown');
        if (floatingDropdown && floatingDropdown.style.display === 'block') {
          if (
            !floatingDropdown.contains(ev.target) &&
            !ev.target.classList.contains('add-roteiro-btn')
          ) {
            floatingDropdown.style.display = 'none';
          }
        }
      });
    }

    function createInfoWindowContent(place) {
      const rating = place.rating ? `
        <div class="info-window-rating">
          <span class="rating-stars">${'★'.repeat(Math.floor(place.rating))}${'☆'.repeat(5-Math.floor(place.rating))}</span>
          <span class="rating-value">${place.rating.toFixed(1)}</span>
        </div>
      ` : '';

      const types = place.types ? place.types.slice(0, 2).map(type => 
        `<span class="info-window-tag">${type.replace(/_/g, ' ')}</span>`
      ).join('') : '';

      return `
        <div class="info-window">
          <button class="info-window-close" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">×</button>
          <h3 class="info-window-title">${place.name}</h3>
          ${rating}
          <div class="info-window-tags">${types}</div>
          <p class="info-window-address">${place.vicinity || ''}</p>
        </div>
      `;
    }

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function getPinIcon(place) {
      const types = place.types || [];
      let iconUrl = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
      if (types.includes('lodging')) iconUrl = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
      if (types.includes('restaurant') || types.includes('food')) iconUrl = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png';
      if (types.includes('tourist_attraction')) iconUrl = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
      
      return {
        url: iconUrl,
        scaledSize: new google.maps.Size(32, 32),
        anchor: new google.maps.Point(16, 32),
        labelOrigin: new google.maps.Point(16, 0)
      };
    }

    // Função utilitária para gerar a chave de cache baseada em centro, raio e tipo
    function getCacheKey(center, radius, type) {
      // Arredonda para 4 casas para evitar chaves demais
      const lat = center.lat.toFixed ? center.lat.toFixed(4) : center.lat().toFixed(4);
      const lng = center.lng.toFixed ? center.lng.toFixed(4) : center.lng().toFixed(4);
      return `places_${lat},${lng}_${radius}_${type}`;
    }

    // Função para buscar do cache ou da API Nearby Search
    function searchNearby(center) {
      clearMarkers();
      document.querySelector('.results-grid').innerHTML = 'Carregando...';
      const cacheKey = getCacheKey(center, RADIUS, selectedType);
      
      // 1. Verifica se já existe cache para esta região, raio e tipo
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        // 2. Se existe, carrega do cache
        const cacheObj = JSON.parse(cached);
        renderResults(cacheObj.results);
        // Renderiza marcadores
        const filtered = cacheObj.results.filter(place => isTypeMatch(place, selectedType));
        filtered.forEach(place => {
          if (place.geometry && place.geometry.location) {
            const marker = new google.maps.Marker({
              map,
              position: place.geometry.location,
              title: place.name,
              icon: getPinIcon(place)
            });

            // Adiciona InfoWindow ao marcador
            const infoWindow = new google.maps.InfoWindow({
              content: createInfoWindowContent(place),
              pixelOffset: new google.maps.Size(0, -32)
            });

            marker.addListener('click', () => {
              // Fecha qualquer InfoWindow aberto
              if (window.currentInfoWindow) {
                window.currentInfoWindow.close();
              }
              infoWindow.open(map, marker);
              window.currentInfoWindow = infoWindow;
            });

            markers.push(marker);
          }
        });
        return;
      }

      // 3. Se não existe cache, faz a requisição Nearby Search
      const request = {
        location: center,
        radius: RADIUS,
        type: selectedType === 'restaurant' ? ['restaurant', 'food', 'cafe', 'bakery', 'bar'] : selectedType
      };

      service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          // 4. Salva no cache com timestamp
          const cacheObj = {
            results,
            timestamp: Date.now()
          };
          localStorage.setItem(cacheKey, JSON.stringify(cacheObj));
          renderResults(results);
          // Renderiza marcadores
          const filtered = results.filter(place => isTypeMatch(place, selectedType));
          filtered.forEach(place => {
            if (place.geometry && place.geometry.location) {
              const marker = new google.maps.Marker({
                map,
                position: place.geometry.location,
                title: place.name,
                icon: getPinIcon(place)
              });

              // Adiciona InfoWindow ao marcador
              const infoWindow = new google.maps.InfoWindow({
                content: createInfoWindowContent(place),
                pixelOffset: new google.maps.Size(0, -32)
              });

              marker.addListener('click', () => {
                // Fecha qualquer InfoWindow aberto
                if (window.currentInfoWindow) {
                  window.currentInfoWindow.close();
                }
                infoWindow.open(map, marker);
                window.currentInfoWindow = infoWindow;
              });

              markers.push(marker);
            }
          });
        } else {
          document.querySelector('.results-grid').innerHTML = 'Nenhum resultado encontrado.';
        }
      });
    }

    function getBuscaPersistida() {
      try {
        return JSON.parse(localStorage.getItem('buscaViajey')) || {};
      } catch {
        return {};
      }
    }

    function preencherBusca({ cidade, checkin, checkout }) {
      console.log('Dados da busca:', { cidade, checkin, checkout });
      
      // Preencher cidade
      const input = document.getElementById('autocomplete');
      if (input) input.value = cidade || '';
      
      // Preencher calendário se datas existirem e Flatpickr estiver pronto
      const trySetCalendar = () => {
        const dateInput = document.getElementById('date-range');
        console.log('Tentando preencher calendário:', {
          dateInput: !!dateInput,
          flatpickr: dateInput?._flatpickr ? 'pronto' : 'não pronto',
          checkin,
          checkout
        });

        if (
          dateInput &&
          dateInput._flatpickr &&
          checkin &&
          checkout
        ) {
          try {
            // Converter datas do formato DD/MM/YYYY para YYYY-MM-DD
            const [d1, m1, y1] = checkin.split('/');
            const [d2, m2, y2] = checkout.split('/');
            const start = new Date(`${y1}-${m1}-${d1}`);
            const end = new Date(`${y2}-${m2}-${d2}`);
            
            console.log('Datas convertidas:', { start, end });
            
            // Configurar o calendário
            dateInput._flatpickr.setDate([start, end]);
            
            // Atualiza o texto do botão
            const calendarBtn = document.querySelector('.calendar-btn');
            if (calendarBtn) {
              const opts = { weekday: 'short', day: '2-digit', month: 'short' };
              const startStr = start.toLocaleDateString('pt-BR', opts).replace('.', '');
              const endStr = end.toLocaleDateString('pt-BR', opts).replace('.', '');
              calendarBtn.querySelector('.calendar-text').textContent = `${startStr} — ${endStr}`;
              console.log('Texto do botão atualizado:', `${startStr} — ${endStr}`);
            }
            return true;
          } catch (error) {
            console.error('Erro ao preencher datas:', error);
            return false;
          }
        }
        return false;
      };

      // Tenta até conseguir setar o calendário
      let tentativas = 0;
      (function waitForCalendar() {
        if (!trySetCalendar() && tentativas < 30) {
          tentativas++;
          console.log(`Tentativa ${tentativas} de preencher calendário`);
          setTimeout(waitForCalendar, 100);
        }
      })();
    }

    function setTituloDinamico() {
      const { cidade } = getBuscaPersistida();
      const titulo = document.querySelector('.results-title');
      if (titulo && cidade) {
        titulo.textContent = `Explorando ${cidade}`;
      }
    }

    function inicializarMapaComCidade() {
      const { cidade } = getBuscaPersistida();
      if (!cidade) {
        console.log('Cidade não definida');
        return;
      }
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(cidade)}&key=${API_KEY}`)
        .then(res => res.json())
        .then(geo => {
          if (geo.results && geo.results[0]) {
            const location = geo.results[0].geometry.location;
            lastCenter = location;
            map = new google.maps.Map(document.getElementById('map'), {
              center: location,
              zoom: lastZoom,
              gestureHandling: 'cooperative'
            });
            service = new google.maps.places.PlacesService(map);
            searchNearby(location);
            btn = document.getElementById('search-area-btn');
            
            // Função para verificar se o mapa está em tela cheia
            const checkMapFullscreen = () => {
              const mapContainer = document.querySelector('.results-map');
              const isFullscreen = window.innerWidth <= 1100;
              if (isFullscreen) {
                btn.style.display = 'block';
              } else {
                btn.style.display = moved ? 'block' : 'none';
              }
            };

            // Verifica inicialmente
            checkMapFullscreen();

            // Adiciona listener para redimensionamento da janela
            window.addEventListener('resize', checkMapFullscreen);

            map.addListener('idle', () => {
              const center = map.getCenter();
              const zoom = map.getZoom();
              if (
                !lastCenter ||
                center.lat() !== lastCenter.lat ||
                center.lng() !== lastCenter.lng ||
                zoom !== lastZoom
              ) {
                moved = true;
                checkMapFullscreen();
              }
            });

            btn.addEventListener('click', () => {
              const center = map.getCenter();
              lastCenter = { lat: center.lat(), lng: center.lng() };
              lastZoom = map.getZoom();
              moved = false;
              checkMapFullscreen();
              searchNearby(center);
            });

            map.addListener('dragstart', () => { 
              moved = true;
              checkMapFullscreen();
            });
            map.addListener('zoom_changed', () => { 
              moved = true;
              checkMapFullscreen();
            });

            document.querySelectorAll('.filters-left .filter-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                document.querySelectorAll('.filters-left .filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                if (this.textContent.includes('Hotel')) selectedType = 'lodging';
                if (this.textContent.includes('Restaurantes')) selectedType = 'restaurant';
                if (this.textContent.includes('Atra')) selectedType = 'tourist_attraction';
                searchNearby(map.getCenter());
              });
            });

            // Adiciona listener global para fechar InfoWindow ao clicar fora
            google.maps.event.addListener(map, 'click', function() {
              if (window.currentInfoWindow) {
                window.currentInfoWindow.close();
                window.currentInfoWindow = null;
              }
            });
          }
        });
    }

    function waitForMap() {
      const mapDiv = document.getElementById('map');
      const input = document.getElementById('autocomplete');
      const dateInput = document.getElementById('date-range');
      const flatpickrReady = dateInput && dateInput._flatpickr;
      
      if (mapDiv && window.google && window.google.maps && input && dateInput && flatpickrReady) {
        const params = getBuscaPersistida();
        preencherBusca(params);
        setTituloDinamico();
        inicializarMapaComCidade();
      } else {
        setTimeout(waitForMap, 100);
      }
    }
    waitForMap();
  </script>
  <script>
    // Inclui o componente search-bar
    fetch('components/search-bar/search-bar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('search-bar-include').innerHTML = html;
        var script = document.createElement('script');
        script.src = 'components/search-bar/search-bar.js';
        document.body.appendChild(script);
      });
  </script>
  <script>
    // Função para checar se o local pertence ao tipo selecionado (prioridade pelo primeiro tipo)
    function isTypeMatch(place, selectedType) {
      if (!place.types || !place.types.length) return false;
      
      // Lista de tipos relacionados a comida
      const foodTypes = [
        'restaurant',
        'food',
        'cafe',
        'bakery',
        'bar',
        'meal_delivery',
        'meal_takeaway',
        'bistro',
        'pizzeria',
        'ice_cream_parlor',
        'coffee_shop'
      ];

      if (selectedType === 'lodging') {
        // Para hotéis, verifica se o primeiro tipo é exatamente 'lodging'
        return place.types[0] === 'lodging';
      }
      
      if (selectedType === 'restaurant') {
        // Para restaurantes, verifica se tem algum tipo de comida E não é hotel
        return place.types.some(type => foodTypes.includes(type)) && 
               !place.types.includes('lodging');
      }
      
      if (selectedType === 'tourist_attraction') {
        return place.types[0] === 'tourist_attraction';
      }
      
      return false;
    }
  </script>
</body>
</html> 